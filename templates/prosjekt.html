<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/stil.css') }}">
</head>
<body>
    <div id="app" class="app-container">
        <header>
            <h1>Enkel meldingsapp</h1>
            <div id="userArea">
                <span id="welcome" style="display:none"></span>
                <button id="logoutBtn" style="display:none">Logg ut</button>
            </div>
        </header>

        <main>
            <section id="authSection">
                <div class="card">
                    <h2>Registrer deg</h2>
                    <form id="registerForm">
                        <label>Brukernavn
                            <input type="text" id="regUsername" required>
                        </label>
                        <label>Passord
                            <input type="password" id="regPassword" required>
                        </label>
                        <button type="submit">Registrer</button>
                    </form>
                </div>

                <div class="card">
                    <h2>Logg inn</h2>
                    <form id="loginForm">
                        <label>Brukernavn
                            <input type="text" id="loginUsername" required>
                        </label>
                        <label>Passord
                            <input type="password" id="loginPassword" required>
                        </label>
                        <button type="submit">Logg inn</button>
                    </form>
                </div>
            </section>

            <section id="chatSection" style="display:none">
                <div class="card">
                    <h2>Meldinger</h2>
                    <div id="messages" class="messages"></div>
                </div>

                <div class="card">
                    <h3>Skriv ny melding</h3>
                    <form id="messageForm">
                        <textarea id="messageText" rows="3" placeholder="Skriv noe..." required></textarea>
                        <div>
                            <button type="submit">Send</button>
                        </div>
                    </form>
                </div>
            </section>
        </main>

        <footer>
            <small>Enkel client-side demo — lagret i nettleserens localStorage</small>
        </footer>
    </div>

    <style>
        .app-container{max-width:800px;margin:20px auto;font-family:Arial,Helvetica,sans-serif}
        header{display:flex;justify-content:space-between;align-items:center}
        .card{border:1px solid #ddd;padding:12px;margin:10px 0;border-radius:6px;background:#fafafa}
        label{display:block;margin:8px 0}
        input, textarea{width:100%;padding:8px;margin-top:4px;box-sizing:border-box}
        button{padding:8px 12px;margin-top:8px}
        .messages{max-height:300px;overflow:auto;border:1px solid #eee;padding:8px;background:#fff}
        .msg{padding:6px;border-bottom:1px solid #f0f0f0}
        .meta{font-size:12px;color:#666}
    </style>

    <script>
        // Enkel bruker- og meldingstjeneste med localStorage
        const LS_USERS = 'simplechat_users';
        const LS_MESSAGES = 'simplechat_messages';
        const LS_CURRENT = 'simplechat_current';

        function loadUsers(){ return JSON.parse(localStorage.getItem(LS_USERS) || '{}'); }
        function saveUsers(u){ localStorage.setItem(LS_USERS, JSON.stringify(u)); }
        function loadMessages(){ return JSON.parse(localStorage.getItem(LS_MESSAGES) || '[]'); }
        function saveMessages(m){ localStorage.setItem(LS_MESSAGES, JSON.stringify(m)); }
        function setCurrentUser(name){ localStorage.setItem(LS_CURRENT, name); }
        function getCurrentUser(){ return localStorage.getItem(LS_CURRENT); }
        function clearCurrentUser(){ localStorage.removeItem(LS_CURRENT); }

        // UI elements
        const registerForm = document.getElementById('registerForm');
        const loginForm = document.getElementById('loginForm');
        const messageForm = document.getElementById('messageForm');
        const messagesDiv = document.getElementById('messages');
        const chatSection = document.getElementById('chatSection');
        const authSection = document.getElementById('authSection');
        const welcomeSpan = document.getElementById('welcome');
        const logoutBtn = document.getElementById('logoutBtn');

        // Register
        registerForm.addEventListener('submit', (e)=>{
            e.preventDefault();
            const u = document.getElementById('regUsername').value.trim();
            const p = document.getElementById('regPassword').value;
            if(!u || !p){ alert('Fyll inn brukernavn og passord'); return; }
            const users = loadUsers();
            if(users[u]){ alert('Brukernavnet er tatt'); return; }
            users[u] = p;
            saveUsers(users);
            alert('Registrering vellykket. Logg inn nå.');
            registerForm.reset();
        });

        // Login
        loginForm.addEventListener('submit', (e)=>{
            e.preventDefault();
            const u = document.getElementById('loginUsername').value.trim();
            const p = document.getElementById('loginPassword').value;
            const users = loadUsers();
            if(users[u] && users[u] === p){
                setCurrentUser(u);
                renderAuthState();
                loginForm.reset();
            } else {
                alert('Feil brukernavn eller passord');
            }
        });

        // Logout
        logoutBtn.addEventListener('click', ()=>{
            clearCurrentUser();
            renderAuthState();
        });

        // Send message
        messageForm.addEventListener('submit', (e)=>{
            e.preventDefault();
            const text = document.getElementById('messageText').value.trim();
            const user = getCurrentUser();
            if(!user){ alert('Du må være logget inn'); return; }
            if(!text) return;
            const messages = loadMessages();
            messages.push({id:Date.now(), user, text, time:new Date().toISOString()});
            saveMessages(messages);
            document.getElementById('messageText').value = '';
            renderMessages();
        });

        // Render messages
        function renderMessages(){
            const messages = loadMessages();
            messagesDiv.innerHTML = '';
            if(messages.length === 0){
                messagesDiv.innerHTML = '<div class="msg">Ingen meldinger ennå.</div>';
                return;
            }
            messages.slice().reverse().forEach(m=>{
                const el = document.createElement('div');
                el.className = 'msg';
                const time = new Date(m.time).toLocaleString();
                el.innerHTML = '<div class="meta"><strong>'+escapeHtml(m.user)+'</strong> • '+time+'</div>'
                                         +'<div>'+escapeHtml(m.text)+'</div>';
                messagesDiv.appendChild(el);
            });
        }

        // Simple HTML escape
        function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

        // Toggle UI based on login state
        function renderAuthState(){
            const user = getCurrentUser();
            if(user){
                authSection.style.display = 'none';
                chatSection.style.display = '';
                welcomeSpan.style.display = '';
                welcomeSpan.textContent = 'Logget inn som ' + user;
                logoutBtn.style.display = '';
                renderMessages();
            } else {
                authSection.style.display = '';
                chatSection.style.display = 'none';
                welcomeSpan.style.display = 'none';
                logoutBtn.style.display = 'none';
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', ()=>{
            renderAuthState();
        });
    </script>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>
</html>